<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student OS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=3">

    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        const setTheme = (theme) => {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);

            // Sync any existing toggle checkboxes on the page
            const themeCheckbox = document.getElementById('theme-checkbox');
            if (themeCheckbox) {
                themeCheckbox.checked = theme === 'dark';
            }
        }

        // Apply theme immediately from localStorage or system preference
        const savedTheme = localStorage.getItem('theme') ||
            (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', savedTheme);

        // Loading Bar Logic
        document.addEventListener('DOMContentLoaded', () => {
            const loader = document.querySelector('.page-loading-bar');

            // Initial load animation
            if (loader) {
                loader.style.width = '30%';
                setTimeout(() => {
                    loader.style.width = '70%';
                }, 200);
                setTimeout(() => {
                    loader.style.width = '100%';
                    setTimeout(() => {
                        loader.style.opacity = '0';
                        setTimeout(() => {
                            loader.style.width = '0%';
                        }, 200);
                    }, 500);
                }, 600);
            }

            // Trigger on links
            document.querySelectorAll('a').forEach(link => {
                link.addEventListener('click', (e) => {
                    const href = link.getAttribute('href');
                    if (href && href.startsWith('/') && !href.startsWith('#') && !e.ctrlKey && !e.metaKey) {
                        if (loader) {
                            loader.style.opacity = '1';
                            loader.style.width = '0%';
                            requestAnimationFrame(() => {
                                loader.style.width = '80%';
                            });
                        }
                    }
                });
            });

            // Trigger on forms
            document.querySelectorAll('form').forEach(form => {
                form.addEventListener('submit', () => {
                    if (loader) {
                        loader.style.opacity = '1';
                        loader.style.width = '0%';
                        requestAnimationFrame(() => {
                            loader.style.width = '90%';
                        });
                    }
                });
            });
        });
    </script>
</head>

<body>
    <div class="page-loading-bar"></div>
    <!-- Sidebar Overlay for Mobile -->
    <div id="sidebar-overlay" class="sidebar-overlay"></div>

    <!-- Mobile Header -->
    <div class="mobile-header">
        <div class="brand">
            <i data-lucide="graduation-cap"></i>
            <span>Student OS</span>
        </div>
        <button id="mobile-toggle" aria-label="Toggle Menu">
            <i data-lucide="menu"></i>
        </button>
    </div>

    <div class="toast-container"
        style="position: fixed; top: 1rem; right: 1rem; z-index: 9999; display: flex; flex-direction: column; gap: 0.5rem; max-width: 400px; width: 90%;">
        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert {{ category }}"
            style="border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid var(--border-color);">
            <div
                style="display: flex; justify-content: space-between; align-items: center; gap: 1rem; padding: 0.75rem 1rem;">
                <span>{{ message }}</span>
                <button onclick="this.parentElement.parentElement.remove()"
                    style="background: none; border: none; color: inherit; cursor: pointer; padding: 0; font-size: 1.25rem; line-height: 1;">&times;</button>
            </div>
        </div>
        {% endfor %}
        <script>
            document.querySelectorAll('.alert').forEach(alert => {
                setTimeout(() => {
                    alert.classList.add('fade-out');
                    setTimeout(() => {
                        alert.remove();
                    }, 500); // Match this with CSS animation duration
                }, 5000); // 5 seconds display time
            });
        </script>
        {% endif %}
        {% endwith %}
    </div>

    {% block content %}{% endblock %}


    <script>
        // Lucide icons initialization
        lucide.createIcons();

        // Mobile Sidebar Controller
        const mobileToggle = document.getElementById('mobile-toggle');
        const mobileClose = document.getElementById('mobile-close');
        const overlay = document.getElementById('sidebar-overlay');
        const sidebar = document.querySelector('.sidebar');

        const toggleSidebar = (show) => {
            if (!sidebar || !overlay) return;
            if (show) {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden'; // Prevent scrolling when menu is open
            } else {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        };

        if (mobileToggle) mobileToggle.addEventListener('click', () => toggleSidebar(true));
        if (mobileClose) mobileClose.addEventListener('click', () => toggleSidebar(false));
        if (overlay) overlay.addEventListener('click', () => toggleSidebar(false));
    </script>
</body>

</html>